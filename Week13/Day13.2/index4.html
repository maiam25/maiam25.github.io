<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>World Cup Alpine Ski Racers</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/4.5.1/alasql.min.js"></script>
<style>
body {
    background: rgb(223, 254, 255);
    font-family:'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Verdana;
}

.container {
    margin: 20px;
}

.import-title {
    font-weight: bold;
    font-size: 18px;
}

.file-text {
    width: 250px;
    padding: 5px;
}

.btn {
    padding: 5px 10px;
    margin-left: 5px;
    background: rgb(82, 114, 218);
    color: white;
    border: none;
    cursor: pointer;
    font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Verdana;
}

.form-row {
    margin-top: 20px;
    display: flex;
    align-items: center;
    gap: 20px;
}

.field {
    display: flex;
    flex-direction: column;
}

.field input {
    padding: 5px;
    width: 120px;
}

.create-btn {
    background: rgb(82, 114, 218);
    color: white;
    padding: 10px 20px;
    border: none;
    cursor: pointer;
}

.sql-section {
    margin-top: 30px;
    display: flex;
    gap: 20px;
}

.sql-box {
    width: 380px;
    height: 200px;
    padding: 10px;
    border: 2px solid rgb(52, 98, 185);
    background-color: rgb(240, 254, 255);
    border-radius: 15px;
    font-family: monospace;
}

.output-box {
    width: 800px;
    height: 400px;
    padding: 10px;
    border: 2px solid rgb(52, 98, 185);
    background-color: rgb(240, 254, 255);
    border-radius: 15px;
    font-family: monospace;
    overflow: auto;
}

.run-btn {
    margin-top: 15px;
    background: rgb(82, 114, 218);
    color: white;
    padding: 10px 20px;
    border: none;
    cursor: pointer;
}
.clear-btn {
    margin-top: 15px;
    margin-left: 10px;
    background: rgb(218, 82, 82);
    color: white;
    padding: 10px 20px;
    border: none;
    cursor: pointer;
}
.save-btn {
    margin-top: 20px;
    background: rgb(82, 218, 130);
    color: white;
    padding: 10px 20px;
    border: none;
    cursor: pointer;
}
.query-results {
    width: 100%;
    border-collapse: collapse;
}
.query-results th, .query-results td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}
.query-results th {
    background-color: #f2f2f2;
}
.output-placeholder {
    color: #888;
}
.example-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
}
.example-btn {
    padding: 5px 10px;
    background: rgb(150, 150, 250);
    color: white;
    border: none;
    cursor: pointer;
    text-align: left;
    font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Verdana;
}
.example-btn:hover {
    background: rgb(120, 120, 220);
}
</style>
</head>
<body>

<div class="container">

    <!-- Import Section -->
    <div class="import-section">
        <label class="import-title">Import File</label><br>
        <input type="text" id="filepath" class="file-text" readonly>
        <input type="file" id="fileInput" style="display:none">
        <button class="btn" id="browseBtn">Browse...</button>
    </div>

    <!-- Inp
ut Fields -->
    <div class="form-row">
        <div class="field">
            <label>ID</label>
            <input type="text" id="id" maxlength="35">
        </div>
        <div class="field">
            <label>Skier Name</label>
            <input type="text" id="skier_name" maxlength="35">
        </div>
        <div class="field">
            <label>Gender</label>
            <input type="text" id="gender" maxlength="35">
        </div>
        <div class="Country">
            <label>Country</label>
            <input type="text" id="Country" maxlength="35">
        </div>
        <div class="field">
            <label>Skis on:</label>
            <input type="text" id="skis_on" maxlength="35">
        </div>
        <div class="field">
            <label>Podiums</label>
            <input type="text" id="podiums" maxlength="35">
        </div>
        <div class="field">
            <label>Victories</label>
            <input type="text" id="victories" maxlength="35">
        <div class="example-buttons">
            <button class="example-btn" data-query='SELECT * FROM data'>1. SELECT * FROM data</button>
            <button class="example-btn" data-query='SELECT "Skier_Name:" FROM data'>2. SELECT "Skier_Name:" FROM data</button>
            <button class="example-btn" data-query='SELECT COUNT(*) as total_rows FROM data'>3. SELECT COUNT(*) as total_rows FROM data</button>
            <button class="example-btn" data-query='SELECT * FROM data LIMIT 5'>4. SELECT * FROM data LIMIT 5</button>
            <button class="example-btn" data-query='SELECT "Skis_on:", COUNT(*) as count FROM data GROUP BY "Skis_on:" ORDER BY count DESC'>5. SELECT "Skis_on:", COUNT(*) as count FROM data GROUP BY "Skis_on:" ORDER BY count DESC</button>
        </div>

    </div>

    <!-- SQL Section -->
    <div class="sql-section">
        <textarea id="sqlBox" class="sql-box" placeholder="Write SQL here..."></textarea>
        <div id="outputBox" class="output-box">
            <div class="output-placeholder">Output...</div>
        </div>
    </div>

    <div>
        <button id="runBtn" class="run-btn">Run SQL</button>
        <button id="clearBtn" class="clear-btn">Clear Output</button>
    </div>

    <button id="saveBtn" class="save-btn">Save Current Data as CSV</button>

</div>

<script>
// ------------------------------
// State
// ------------------------------
let currentData = [];

// ------------------------------
// File Browse & Import
// ------------------------------
document.getElementById('browseBtn').addEventListener('click', () => {
    document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', async (event) => {
    const file = event.target.files && event.target.files[0];
    if (!file) return;
    document.getElementById('filepath').value = file.name;
    const text = await file.text();
    currentData = parseCSV(text);
    alert(`File imported successfully! ${currentData.length} rows loaded.`);
});

function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/).filter(l => l.trim() !== '');
    if (lines.length < 1) return [];
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((header, index) => {
            row[header] = values[index] || '';
        });
        data.push(row);
    }
    return data;
}

function parseCSVLine(line) {
    const values = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
            inQuotes = !inQuotes;
        } else if (ch === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
        } else {
            current += ch;
        }
    }
    values.push(current.trim());
    return values;
}

// ------------------------------
// Create New Entry
// ------------------------------
document.getElementById('createBtn').addEventListener('click', () => {
    const id = document.getElementById('id').value.trim();
    const skierName = document.getElementById('skier_name').value.trim();
    const gender = document.getElementById('gender').value.trim();
    const country = document.getElementById('country').value.trim();
    const skisOn = document.getElementById('skis_on').value.trim();
    const podiums = document.getElementById('podiums').value.trim();
    const victories = document.getElementById('victories').value.trim();

    if (!id || !skierName) {
        alert('Please fill at least ID and Skier Name.');
        return;
    }

    // Create a default row with readable keys
    const newEntry = {
        'ID:': id,
        'Skier_Name:': skierName,
        'Gender:': gender,
        'Country:': country,
        'Skis_on:': skisOn,
        'Podiums:': podiums,
        'Victories:': victories
    };

    currentData.push(newEntry);
    alert('New Entry created.');
    displayResults(currentData, document.getElementById('outputBox'));

    // clear form
    document.getElementById('id').value = '';
    document.getElementById('skier_name').value = '';
    document.getElementById('gender').value = '';
    document.getElementById('country').value = '';
    document.getElementById('skis_on').value = '';
    document.getElementById('podiums').value = '';
    document.getElementById('victories').value = '';
});

// ------------------------------
// Example queries
// ------------------------------
document.querySelectorAll('.example-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.getElementById('sqlBox').value = btn.getAttribute('data-query');
    });
});

// ------------------------------
// Run SQL using AlaSQL (replace FROM data -> FROM ?)
// ------------------------------
document.getElementById('runBtn').addEventListener('click', () => {
    const sql = document.getElementById('sqlBox').value.trim();
    const outputBox = document.getElementById('outputBox');
    if (!sql) return;
    if (!currentData || currentData.length === 0) {
        outputBox.innerHTML = '<div style="color: red;">No data loaded. Please import a file first or create entries.</div>';
        return;
    }

    try {
        // replace 'FROM data' (case-insensitive) with 'FROM ?' so we can pass the array
        const prepared = sql.replace(/\bFROM\s+data\b/i, 'FROM ?');
        const result = alasql(prepared, [currentData]);
        displayResults(result, outputBox);
    } catch (err) {
        outputBox.innerHTML = `<div style="color: red;">Error: ${err.message}</div>`;
    }
});

// ------------------------------
// Display results helper
// ------------------------------
function displayResults(results, container) {
    if (!results || results.length === 0) {
        container.innerHTML = '<div>No results found</div>';
        return;
    }
    const columns = Object.keys(results[0]);
    let html = '<table class="query-results">';
    html += '<thead><tr>' + columns.map(c => `<th>${c}</th>`).join('') + '</tr></thead>';
    html += '<tbody>' + results.map(r => '<tr>' + columns.map(c => `<td>${r[c] !== undefined ? r[c] : ''}</td>`).join('') + '</tr>').join('') + '</tbody>';
    html += '</table>';
    container.innerHTML = html;
}

// ------------------------------
// Clear output
// ------------------------------
document.getElementById('clearBtn').addEventListener('click', () => {
    document.getElementById('outputBox').innerHTML = '<div class="output-placeholder">Output...</div>';
});

// ------------------------------
// Save current data as CSV
// ------------------------------
document.getElementById('saveBtn').addEventListener('click', () => {
    if (!currentData || currentData.length === 0) {
        alert('No data to save. Please import a file or create entries first.');
        return;
    }
    const headers = Object.keys(currentData[0]);
    let csv = headers.join(',') + '\n';
    currentData.forEach(row => {
        const vals = headers.map(h => {
            const v = row[h] || '';
            return v.toString().includes(',') ? `"${v}"` : v;
        });
        csv += vals.join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ski_racers_export.csv';
    a.click();
    URL.revokeObjectURL(url);
    alert('CSV file saved successfully!');
});
</script>

</body>
</html>
// ------------------------------
// Clear Output Button
// ------------------------------
document.getElementById("clearBtn").addEventListener("click", () => {
    document.getElementById("outputBox").innerHTML = '<div class="output-placeholder">Output...</div>';
});

// ------------------------------
// Save Current Data as CSV
// ------------------------------
document.getElementById("saveBtn").addEventListener("click", () => {
    if (currentData.length === 0) {
        alert("No data to save. Please import a file or create entries first.");
        return;
    }

    // Get headers from first row
    const headers = Object.keys(currentData[0]);
    
    // Create CSV content
    let csvContent = headers.join(',') + '\n';
    
    currentData.forEach(row => {
        const values = headers.map(header => {
            const value = row[header] || '';
            // Wrap in quotes if contains comma
            return value.toString().includes(',') ? `"${value}"` : value;
        });
        csvContent += values.join(',') + '\n';
    });
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url;
    a.download = 'exported_data.csv';
    a.click();
    window.URL.revokeObjectURL(url);
    alert("Data saved as exported_data.csv");
});
</script>
</body>
</html>